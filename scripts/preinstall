#!/bin/bash

# Preinstall script for MacScope VirtualHID
# Stops existing daemon and cleans up old installations

set -euo pipefail

PLIST_PATH="/Library/LaunchDaemons/com.macscope.vhid.relay.plist"
LOG_FILE="/var/log/macscope-vhid-preinstall.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

log "Starting preinstall cleanup..."

# Stop daemon if running
if launchctl list | grep -q "com.macscope.vhid.relay" 2>/dev/null; then
    log "Stopping existing daemon..."
    launchctl bootout system "$PLIST_PATH" 2>/dev/null || true
    sleep 1
    log "Daemon stopped"
fi

# Clean up old sockets
log "Cleaning up old sockets..."
rm -f /tmp/macs_vhid_*.sock
log "Sockets cleaned"

# Backup existing binary if present
if [[ -f "/usr/local/bin/macscope-vhid" ]]; then
    backup_path="/usr/local/bin/macscope-vhid.backup.$(date +%s)"
    log "Backing up existing binary to: $backup_path"
    cp "/usr/local/bin/macscope-vhid" "$backup_path"
fi

log "Preinstall cleanup completed"
exit 0
